name: Build Linux ARM64

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  set_version:
    name: Get version info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.outputs.outputs.version }}
      tag: ${{ steps.outputs.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ^1.25
          
      - name: Get version from tag
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(go run -v ./cmd/internal/read_tag --nightly)
          fi
          echo "version=$VERSION" >> "$GITHUB_ENV"
          
      - name: Set outputs
        id: outputs
        run: |
          echo "version=${{ env.version }}" >> "$GITHUB_OUTPUT"
          echo "tag=v${{ env.version }}" >> "$GITHUB_OUTPUT"

  build_linux_arm64:
    name: Build Linux ARM64 binary
    runs-on: ubuntu-latest
    needs: set_version
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ^1.25
          
      - name: Set build tags
        run: |
          # 包含ssr协议支持和其他常用功能
          TAGS='with_shadowsocksr,with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale'
          echo "BUILD_TAGS=${TAGS}" >> "${GITHUB_ENV}"
          
      - name: Build Linux ARM64
        run: |
          set -xeuo pipefail
          mkdir -p dist
          
          # 编译Linux ARM64版本
          CGO_ENABLED=0 \
          GOOS=linux \
          GOARCH=arm64 \
          go build -v -trimpath \
            -o dist/sing-box-linux-arm64 \
            -tags "${BUILD_TAGS}" \
            -ldflags "-s -w -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ needs.set_version.outputs.version }}" \
            ./cmd/sing-box
          
          # 验证编译结果
          file dist/sing-box-linux-arm64
          
      - name: Package binary
        run: |
          set -xeuo pipefail
          cd dist
          
          # 创建发布目录
          DIR_NAME="sing-box-${{ needs.set_version.outputs.version }}-linux-arm64"
          mkdir -p "${DIR_NAME}"
          
          # 复制文件
          cp ../LICENSE "${DIR_NAME}"
          cp sing-box-linux-arm64 "${DIR_NAME}/sing-box"
          
          # 创建压缩包
          tar -czvf "${DIR_NAME}.tar.gz" "${DIR_NAME}"
          zip -r "${DIR_NAME}.zip" "${DIR_NAME}"
          
          # 清理临时文件
          rm -r "${DIR_NAME}"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-linux-arm64
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/sing-box-linux-arm64
          
      - name: Upload to GitHub Release
        if: github.event_name != 'pull_request'
        run: |
          cd dist
          gh release create ${{ needs.set_version.outputs.tag }} \
            --title "sing-box ${{ needs.set_version.outputs.version }} (Linux ARM64)" \
            --notes "Linux ARM64 build of sing-box ${{ needs.set_version.outputs.version }}" \
            --prerelease \
            *.tar.gz *.zip sing-box-linux-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
