name: Build Linux ARM64

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  set_version:
    name: Get version info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.outputs.outputs.version }}
      tag: ${{ steps.outputs.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.21'  # 使用兼容的Go版本
          
      - name: Get version from tag
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(go run -v ./cmd/internal/read_tag --nightly 2>/dev/null || echo "1.5.5.1")
          fi
          echo "version=$VERSION" >> "$GITHUB_ENV"
          
      - name: Set outputs
        id: outputs
        run: |
          echo "version=${{ env.version }}" >> "$GITHUB_OUTPUT"
          echo "tag=v${{ env.version }}" >> "$GITHUB_OUTPUT"

  build_linux_arm64:
    name: Build Linux ARM64 binary
    runs-on: ubuntu-latest
    needs: set_version
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.21'  # 使用兼容的Go版本
          
      - name: Set build tags
        run: |
          # 移除gvisor以避免兼容性问题
          TAGS='with_shadowsocksr,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale'
          echo "BUILD_TAGS=${TAGS}" >> "${GITHUB_ENV}"
          
      - name: Build Linux ARM64
        run: |
          set -xeuo pipefail
          mkdir -p dist
          
          # 编译Linux ARM64版本
          CGO_ENABLED=0 \
          GOOS=linux \
          GOARCH=arm64 \
          go build -v -trimpath \
            -o dist/sing-box-linux-arm64 \
            -tags "${BUILD_TAGS}" \
            -ldflags "-s -w -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ needs.set_version.outputs.version }}" \
            ./cmd/sing-box
          
          # 验证编译结果
          file dist/sing-box-linux-arm64 || true
          
      - name: Package binary
        run: |
          set -xeuo pipefail
          cd dist
          
          # 创建发布目录
          DIR_NAME="sing-box-${{ needs.set_version.outputs.version }}-linux-arm64"
          mkdir -p "${DIR_NAME}"
          
          # 复制文件
          cp ../LICENSE "${DIR_NAME}" 2>/dev/null || true
          cp sing-box-linux-arm64 "${DIR_NAME}/sing-box"
          
          # 创建压缩包
          tar -czvf "${DIR_NAME}.tar.gz" "${DIR_NAME}" || true
          zip -r "${DIR_NAME}.zip" "${DIR_NAME}" || true
          
          # 清理临时文件
          rm -r "${DIR_NAME}" || true
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-linux-arm64
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/sing-box-linux-arm64
          
      - name: Upload to GitHub Release
        if: github.event_name != 'pull_request' && github.ref_type == 'tag'
        run: |
          cd dist
          for file in *.tar.gz *.zip sing-box-linux-arm64; do
            if [ -f "$file" ]; then
              gh release upload ${{ needs.set_version.outputs.tag }} "$file" --clobber || true
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
